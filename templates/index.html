<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CS 421 Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="app">
      <header class="app-header">
        <h1>CS 421 Chatbot</h1>
        <p>Type a message below and the bot will respond with sentiment & style analysis.</p>
      </header>

      <main class="chat-container" id="chat">
        <!-- Messages will be appended here -->
      </main>

      <form id="chat-form" class="chat-input">
        <textarea
          id="message"
          rows="2"
          placeholder="Type your message here..."
          autocomplete="off"
        ></textarea>
        <button type="submit">Send</button>
      </form>
    </div>

    <script>
      const chat = document.getElementById("chat");
      const form = document.getElementById("chat-form");
      const textarea = document.getElementById("message");

      function appendMessage(sender, text) {
        const wrapper = document.createElement("div");
        wrapper.className = "message-row " + (sender === "user" ? "user" : "bot");

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chat.appendChild(wrapper);

        chat.scrollTop = chat.scrollHeight;
      }

      // Initial greeting
      appendMessage("bot", "Welcome to the CS 421 chatbot! Tell me how you're feeling today.");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = textarea.value.trim();
        if (!text) return;

        appendMessage("user", text);
        textarea.value = "";
        textarea.focus();

        // Show a temporary "typing..." message
        const typingId = "typing-indicator";
        const typing = document.createElement("div");
        typing.id = typingId;
        typing.className = "message-row bot";
        typing.innerHTML = '<div class="message-bubble typing">Thinking...</div>';
        chat.appendChild(typing);
        chat.scrollTop = chat.scrollHeight;

        try {
          const resp = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text }),
          });

          const data = await resp.json();

          // Remove typing indicator
          typing.remove();

          if (data.error) {
            appendMessage("bot", "Error: " + data.error);
          } else {
            const combined =
              data.sentiment + "\n\n" + data.style;
            appendMessage("bot", combined);
          }
        } catch (err) {
          typing.remove();
          appendMessage(
            "bot",
            "Oops, something went wrong talking to the server. Please try again."
          );
        }
      });
    </script>
  </body>
</html>

